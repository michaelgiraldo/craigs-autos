---
import { Image } from 'astro:assets';
import LanguageSwitcher from '../components/LanguageSwitcher.astro';
import ChatWidget from '../components/ChatWidget.astro';
import '../styles/global.css';
import brandLogo from '../assets/brand/craigs-auto-upholstery-logo.png';
import {
	BRAND_NAME,
	BUSINESS_COPY,
	NAV_LABELS,
	LOCALES,
	LOCALE_ORDER,
	PAGE_PATHS,
	SITE,
	UI_COPY,
	getTranslations,
} from '../lib/site-data.js';

// Astro MDX layouts may pass frontmatter under `Astro.props.frontmatter` (vs directly on props).
const frontmatter = Astro.props?.frontmatter ?? Astro.props ?? {};

const {
	title,
	description,
	canonicalPath: canonicalPathProp,
	locale = 'en',
	lang = LOCALES.en.lang,
	translations,
	pageKey,
	noindex = false,
} = frontmatter;
const site = Astro.site ?? new URL(SITE.url);
const pageTranslations = translations ?? getTranslations(pageKey ?? 'home');
const canonicalPath = canonicalPathProp ?? pageTranslations[locale] ?? LOCALES.en.base;
const canonicalUrl = new URL(canonicalPath, site).toString();
const logoUrl = new URL('/brand/logo-512.png', site).toString();
const ogImageUrl = new URL('/og-image.jpg', site).toString();
const isProduction = import.meta.env.PROD;
const gtmId = typeof import.meta.env.PUBLIC_GTM_ID === 'string' ? import.meta.env.PUBLIC_GTM_ID.trim() : '';
const gtmEnabled =
	isProduction && /^GTM-[A-Z0-9]{6,20}$/i.test(gtmId) && !/disabled/i.test(gtmId);
const gtmPageContext = {
	event: 'page_context',
	locale,
	pageKey: pageKey ?? null,
	canonical: canonicalUrl,
};

const ui = UI_COPY[locale] ?? UI_COPY.en;

const mapsQuery = encodeURIComponent(
	`${SITE.address.street}, ${SITE.address.city}, ${SITE.address.region} ${SITE.address.postalCode}`,
);
const mapsHref = `https://www.google.com/maps/dir/?api=1&destination=${mapsQuery}`;
const appleMapsHref = SITE.appleMapsUrl;
const smsHref = `sms:${SITE.phone}`;

const resolvedTranslations = {};
for (const key of LOCALE_ORDER) {
	resolvedTranslations[key] = pageTranslations?.[key] ?? LOCALES[key].base;
}

// Only emit hreflang for locales that actually have this page translated.
const hreflangLocaleKeys = LOCALE_ORDER.filter((key) => Boolean(pageTranslations?.[key]));
const xDefaultHref = new URL(pageTranslations?.en ?? canonicalPath ?? LOCALES.en.base, site).toString();

const hreflangLinks = hreflangLocaleKeys.map((key) => ({
	hreflang: LOCALES[key].hreflang,
	href: new URL(pageTranslations[key], site).toString(),
}));

const buildLanguageLink = (key) => {
	const localeMeta = LOCALES[key];
	if (!localeMeta) {
		return null;
	}
	const nativeLabel = localeMeta.nativeLabel ?? localeMeta.label;
	const englishLabel = localeMeta.englishLabel ?? nativeLabel;
	const menuLabel =
		nativeLabel === englishLabel ? nativeLabel : `${nativeLabel} (${englishLabel})`;
	const searchLabel = `${nativeLabel} ${englishLabel} ${localeMeta.label} ${key}`.toLowerCase();
	return {
		key,
		label: localeMeta.label,
		menuLabel,
		searchLabel,
		href: resolvedTranslations[key],
	};
};

const languageLinks = LOCALE_ORDER.map(buildLanguageLink).filter(Boolean);

const currentLanguageLabel = LOCALES[locale]?.label ?? LOCALES.en.label;
const textDirection = locale === 'ar' ? 'rtl' : 'ltr';

const navLabels = NAV_LABELS[locale] ?? NAV_LABELS.en;
const navItemKeys = [
	'autoUpholstery',
	'carSeats',
	'motorcycleSeats',
	'headliners',
	'convertibleTops',
	'classicCars',
	'upholsteryGuide',
	'gallery',
	'reviews',
	'contact',
];
const fallbackNavLabels = NAV_LABELS.en ?? {};
const navItems = navItemKeys
	.map((key) => {
		const href = PAGE_PATHS[key]?.[locale];
		if (!href) {
			return null;
		}
		return {
			key,
			href,
			label: navLabels[key] ?? fallbackNavLabels[key] ?? key,
		};
	})
	.filter(Boolean);

const navItemsByKey = Object.fromEntries(navItems.map((item) => [item.key, item]));
const servicesLabel = navLabels.services ?? fallbackNavLabels.services ?? 'Services';
const servicesNav = [
	'autoUpholstery',
	'carSeats',
	'headliners',
	'convertibleTops',
	'classicCars',
]
	.map((key) => navItemsByKey[key])
	.filter(Boolean);
const mobilePrimaryNav = ['autoUpholstery', 'carSeats', 'headliners', 'convertibleTops']
	.map((key) => navItemsByKey[key])
	.filter(Boolean);
const mobileSecondaryNav = [
	'classicCars',
	'motorcycleSeats',
	'upholsteryGuide',
	'gallery',
	'reviews',
	'contact',
]
	.map((key) => navItemsByKey[key])
	.filter(Boolean);

const business = BUSINESS_COPY[locale] ?? BUSINESS_COPY.en;
const businessId = new URL('#business', site).toString();

const websiteId = new URL(`${LOCALES[locale]?.base ?? LOCALES.en.base}#website`, site).toString();
const webpageId = `${canonicalUrl}#webpage`;
const breadcrumbId = `${canonicalUrl}#breadcrumb`;

const serviceKeys = ['autoUpholstery', 'carSeats', 'headliners', 'convertibleTops', 'classicCars'];
const serviceNodesByKey = Object.fromEntries(
	serviceKeys.map((key) => [
		key,
		{
			'@type': 'Service',
			'@id': `${new URL(PAGE_PATHS[key][locale], site).toString()}#service`,
			name: navLabels?.[key] ?? key,
			url: new URL(PAGE_PATHS[key][locale], site).toString(),
			provider: { '@id': businessId },
		},
	]),
);

const mainEntityId =
	pageKey && serviceNodesByKey[pageKey] ? serviceNodesByKey[pageKey]['@id'] : businessId;

const businessNode = {
	'@type': ['LocalBusiness'],
	'@id': businessId,
	name: business.name,
	legalName: BRAND_NAME,
	description: business.description,
	url: new URL(PAGE_PATHS.home[locale], site).toString(),
	logo: logoUrl,
	telephone: SITE.phone,
	hasMap: appleMapsHref ? [mapsHref, appleMapsHref] : mapsHref,
	sameAs: SITE.sameAs,
	// We intentionally omit AggregateRating/ReviewSnippet markup here:
	// for LocalBusiness, self-serving reviews are typically ineligible for star rich results.
	geo: {
		'@type': 'GeoCoordinates',
		latitude: SITE.geo.latitude,
		longitude: SITE.geo.longitude,
	},
	address: {
		'@type': 'PostalAddress',
		streetAddress: SITE.address.street,
		addressLocality: SITE.address.city,
		addressRegion: SITE.address.region,
		postalCode: SITE.address.postalCode,
		addressCountry: SITE.address.country,
	},
	openingHoursSpecification: SITE.hours.map((range) => ({
		'@type': 'OpeningHoursSpecification',
		dayOfWeek: range.days,
		opens: range.opens,
		closes: range.closes,
	})),
	areaServed: 'San Jose, CA',
};

const breadcrumbItems = [
	{
		'@type': 'ListItem',
		position: 1,
		name: navLabels.home,
		item: new URL(PAGE_PATHS.home[locale], site).toString(),
	},
];

if (pageKey && pageKey !== 'home') {
	breadcrumbItems.push({
		'@type': 'ListItem',
		position: 2,
		name: navLabels?.[pageKey] ?? title,
		item: canonicalUrl,
	});
}

const websiteNode = {
	'@type': 'WebSite',
	'@id': websiteId,
	url: new URL(LOCALES[locale]?.base ?? LOCALES.en.base, site).toString(),
	name: BRAND_NAME,
	publisher: { '@id': businessId },
};

const breadcrumbNode = {
	'@type': 'BreadcrumbList',
	'@id': breadcrumbId,
	itemListElement: breadcrumbItems,
};

const webpageNode = {
	'@type': 'WebPage',
	'@id': webpageId,
	url: canonicalUrl,
	name: title,
	description,
	inLanguage: lang,
	isPartOf: { '@id': websiteId },
	about: { '@id': businessId },
	mainEntity: { '@id': mainEntityId },
	breadcrumb: { '@id': breadcrumbId },
};

const structuredData = {
	'@context': 'https://schema.org',
	'@graph': [businessNode, websiteNode, webpageNode, breadcrumbNode, ...Object.values(serviceNodesByKey)],
};

// SEO notes:
// - Canonical URLs help prevent duplicate-content signals across language variants.
// - Hreflang declares the full language set (plus x-default) to search engines.
// - JSON-LD reinforces local business details and breadcrumb paths.
---

<!doctype html>
<html lang={lang} dir={textDirection}>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<script is:inline>
			{`(function(){try{var p=new URLSearchParams(window.location.search);var keys=['gclid','gbraid','wbraid','utm_source','utm_medium','utm_campaign','utm_term','utm_content'];var next={};for(var i=0;i<keys.length;i++){var k=keys[i];var v=p.get(k);if(v){next[k]=v;}}var hasNext=Object.keys(next).length>0;var key='craigs_attribution_v1';var existing={};try{existing=JSON.parse(window.localStorage.getItem(key)||'{}')||{};}catch(e){existing={};}var now=new Date().toISOString();var updated=existing||{};if(hasNext){var touch=Object.assign({ts:now,landing_page:window.location.pathname},next);updated.last_touch=touch;if(!updated.first_touch){updated.first_touch=touch;}}if(!updated.referrer&&document.referrer){updated.referrer=document.referrer;}if(!updated.landing_page){updated.landing_page=window.location.pathname;}if(Object.keys(updated).length){window.localStorage.setItem(key,JSON.stringify(updated));}var maxAge=60*60*24*90;if(next.gclid){document.cookie='gclid='+encodeURIComponent(next.gclid)+'; path=/; max-age='+maxAge+'; SameSite=Lax';}if(next.gbraid){document.cookie='gbraid='+encodeURIComponent(next.gbraid)+'; path=/; max-age='+maxAge+'; SameSite=Lax';}if(next.wbraid){document.cookie='wbraid='+encodeURIComponent(next.wbraid)+'; path=/; max-age='+maxAge+'; SameSite=Lax';}}catch(e){}})();`}
		</script>
		{gtmEnabled ? (
			<>
				<link rel="preconnect" href="https://www.googletagmanager.com" />
				<link rel="dns-prefetch" href="https://www.googletagmanager.com" />
				<script
					is:inline
					set:html={`
window.dataLayer = window.dataLayer || [];
window.dataLayer.push(${JSON.stringify(gtmPageContext)});
`}
				/>
				<script
					is:inline
					set:html={`
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','${gtmId}');
`}
				/>
			</>
		) : null}
		<script src="/lead-signals.js" defer></script>
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
		<meta name="description" content={description} />
		<meta name="msvalidate.01" content="8E6AAAC756CDF5BC52BCC838B3C4753C" />
		<link rel="icon" href="/favicon.ico" sizes="any" />
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />
		<link rel="icon" type="image/png" sizes="64x64" href="/favicon-64.png" />
		<link rel="icon" type="image/png" sizes="48x48" href="/favicon-48.png" />
		<link rel="icon" type="image/png" sizes="128x128" href="/favicon-128.png" />
		<link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png" />
		<link rel="icon" type="image/png" sizes="256x256" href="/favicon-256.png" />
		<link rel="icon" type="image/png" sizes="512x512" href="/favicon-512.png" />
		<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
		{noindex ? <meta name="robots" content="noindex, follow" /> : null}
		<link rel="canonical" href={canonicalUrl} />
		<meta property="og:type" content="website" />
		<meta property="og:site_name" content={BRAND_NAME} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:url" content={canonicalUrl} />
		<meta property="og:image" content={ogImageUrl} />
		<meta property="og:image:alt" content={BRAND_NAME} />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={ogImageUrl} />
		{hreflangLinks.map((link) => (
			<link rel="alternate" hreflang={link.hreflang} href={link.href} />
		))}
		<link rel="alternate" hreflang="x-default" href={xDefaultHref} />
		<script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
		<!-- ChatKit web component runtime (renders the full chat UI; our code only wraps it). -->
		<script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" defer></script>
	</head>
	<body>
		{gtmEnabled ? (
			<noscript>
				<iframe
					src={`https://www.googletagmanager.com/ns.html?id=${gtmId}`}
					height="0"
					width="0"
					style="display:none;visibility:hidden"
					title="Google Tag Manager"
				/>
			</noscript>
		) : null}
		<a class="skip-link" href="#main-content">Skip to content</a>
		<header class="site-header">
				<div class="container site-header__mobile">
					<div class="site-header__mobile-top">
						<a class="brand" href={LOCALES[locale]?.base ?? LOCALES.en.base}>
							<span class="brand__logo">
								<Image
									src={brandLogo}
									alt={BRAND_NAME}
									width={56}
									height={56}
									loading="eager"
									decoding="async"
								/>
							</span>
							{BRAND_NAME}
						</a>
						<div class="site-header__mobile-actions">
							<button
								class="site-menu-toggle"
								type="button"
								aria-haspopup="dialog"
								aria-expanded="false"
								aria-controls="site-menu-panel"
								aria-label={ui.menuLabel ?? 'Menu'}
								title={ui.menuLabel ?? 'Menu'}
								data-site-menu-toggle
							>
								<svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
									<path d="M4 6h16" />
									<path d="M4 12h16" />
									<path d="M4 18h16" />
								</svg>
							</button>
							<LanguageSwitcher
								links={languageLinks}
								currentLabel={currentLanguageLabel}
								ariaLabel={ui.languageLabel ?? 'Language'}
								id="lang-switcher"
								mode="toggle"
							/>
						</div>
					</div>
				</div>
			<div class="container site-header__inner">
				<div class="brand-block">
					<a class="brand" href={LOCALES[locale]?.base ?? LOCALES.en.base}>
						<span class="brand__logo">
							<Image
								src={brandLogo}
								alt={BRAND_NAME}
								width={64}
								height={64}
								loading="eager"
								decoding="async"
							/>
						</span>
						{BRAND_NAME}
						</a>
						<a class="brand__sub" href={mapsHref}>
							<span dir="ltr">
								{SITE.address.street}, {SITE.address.city}, {SITE.address.region} {SITE.address.postalCode}
							</span>
						</a>
					</div>
				<div class="site-header__right">
					<div class="header-contact">
						<div class="header-contact__row">
							<a class="header-phone" href={`tel:${SITE.phone}`}>
								<span dir="ltr">{SITE.displayPhone}</span>
							</a>
							<a class="header-text" href={smsHref}>
								<svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
									<path
										d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
									/>
								</svg>
								{ui.textCta ?? 'Text'}
							</a>
						</div>
					</div>
					<LanguageSwitcher
						links={languageLinks}
						currentLabel={currentLanguageLabel}
						ariaLabel={ui.languageLabel ?? 'Language'}
						id="lang-switcher"
						mode="toggle"
					/>
				</div>
				</div>
				<nav class="site-nav" aria-label="Primary">
					<div class="container">
						<ul class="site-nav__list site-nav__list--mobile site-nav__list--mobile-primary">
							{mobilePrimaryNav.map((item) => (
								<li>
									<a
										class="site-nav__link"
										href={item.href}
										aria-current={item.href === canonicalPath ? 'page' : undefined}
									>
										{item.label}
									</a>
								</li>
							))}
						</ul>
						<ul class="site-nav__list site-nav__list--mobile site-nav__list--mobile-secondary">
							{mobileSecondaryNav.map((item) => (
								<li>
									<a
										class="site-nav__link"
										href={item.href}
										aria-current={item.href === canonicalPath ? 'page' : undefined}
									>
										{item.label}
									</a>
								</li>
							))}
						</ul>
						<ul class="site-nav__list site-nav__list--desktop">
							{servicesNav.length > 0 && (
								<li class="site-nav__item site-nav__item--panel">
									<details class="site-nav__panel" data-nav-panel>
										<summary class="site-nav__link site-nav__link--trigger" aria-haspopup="true">
											<span>{servicesLabel}</span>
										</summary>
										<div class="site-nav__panel-body">
											<div class="site-nav__panel-grid">
												<div class="site-nav__panel-column">
													<ul class="site-nav__panel-list">
														{servicesNav.map((item) => (
															<li>
																<a
																	class="site-nav__panel-link"
																	href={item.href}
																	aria-current={item.href === canonicalPath ? 'page' : undefined}
																>
																	{item.label}
																</a>
															</li>
														))}
													</ul>
												</div>
											</div>
										</div>
									</details>
								</li>
							)}
							{navItemsByKey.motorcycleSeats && (
								<li>
									<a
										class="site-nav__link"
										href={navItemsByKey.motorcycleSeats.href}
										aria-current={
											navItemsByKey.motorcycleSeats.href === canonicalPath ? 'page' : undefined
										}
									>
										{navItemsByKey.motorcycleSeats.label}
									</a>
								</li>
							)}
							{navItemsByKey.gallery && (
								<li>
									<a
										class="site-nav__link"
										href={navItemsByKey.gallery.href}
										aria-current={navItemsByKey.gallery.href === canonicalPath ? 'page' : undefined}
									>
										{navItemsByKey.gallery.label}
									</a>
								</li>
							)}
							{navItemsByKey.upholsteryGuide && (
								<li>
									<a
										class="site-nav__link"
										href={navItemsByKey.upholsteryGuide.href}
										aria-current={
											navItemsByKey.upholsteryGuide.href === canonicalPath ? 'page' : undefined
										}
									>
										{navItemsByKey.upholsteryGuide.label}
									</a>
								</li>
							)}
							{navItemsByKey.reviews && (
								<li>
									<a
										class="site-nav__link"
										href={navItemsByKey.reviews.href}
										aria-current={navItemsByKey.reviews.href === canonicalPath ? 'page' : undefined}
									>
										{navItemsByKey.reviews.label}
									</a>
								</li>
							)}
							{navItemsByKey.contact && (
								<li>
									<a
										class="site-nav__link site-nav__link--cta"
										href={navItemsByKey.contact.href}
										aria-current={navItemsByKey.contact.href === canonicalPath ? 'page' : undefined}
									>
										{navItemsByKey.contact.label}
									</a>
								</li>
							)}
					</ul>
				</div>
			</nav>
		</header>
		<main id="main-content" class="page">
			<slot />
		</main>
		<footer class="site-footer">
			<div class="container site-footer__grid">
				<div>
					<p class="site-footer__brand">{BRAND_NAME}</p>
					<p>
						<span dir="ltr">
							{SITE.address.street}, {SITE.address.city}, {SITE.address.region} {SITE.address.postalCode}
						</span>
					</p>
					<p>
						<strong>{ui.hoursLabel}:</strong>{' '}
						{locale === 'ar' ? (
							<>
								الاثنين–الجمعة <span dir="ltr">8:00–17:00</span> · السبت{' '}
								<span dir="ltr">8:00–14:00</span> · الأحد مغلق
							</>
						) : (
							ui.hoursSummary
						)}
					</p>
					<ul class="site-footer__links">
						<li>
							<a href={`tel:${SITE.phone}`}>
								<span dir="ltr">{SITE.displayPhone}</span>
							</a>
						</li>
						<li>
							<a href={smsHref}>{ui.textCta ?? 'Text'}</a>
						</li>
						<li>
							<a href={mapsHref}>{ui.directionsCta}</a>
						</li>
						<li>
							<a href={appleMapsHref}>{ui.appleMapsLabel}</a>
						</li>
						<li>
							<a href={SITE.sameAs[0]}>{ui.yelpLabel}</a>
						</li>
						<li>
							<a href={SITE.sameAs[1]}>{ui.googleLabel}</a>
						</li>
					</ul>
				</div>
				<div>
					<ul class="site-footer__links">
						{navItems.map((item) => (
							<li>
								<a href={item.href}>{item.label}</a>
							</li>
						))}
					</ul>
				</div>
			</div>
		</footer>
		<ChatWidget locale={locale} />
			<div class="sticky-cta" role="region" aria-label={ui.quickActionsLabel}>
				<div class="sticky-cta__inner">
				<a class="sticky-cta__call" href={`tel:${SITE.phone}`}>
					<svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
						<path
							d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.08 4.18 2 2 0 0 1 4.06 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
						/>
					</svg>
					<span>{ui.callCta}</span>
					<span class="sticky-cta__number" dir="ltr">
						{SITE.displayPhone}
					</span>
				</a>
				<a class="sticky-cta__text" href={smsHref}>
					<svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
						<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
					</svg>
					{ui.textCta ?? 'Text'}
				</a>
				<a class="sticky-cta__dir" href={mapsHref}>
					<svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
						<path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 0 1 18 0z" />
						<circle cx="12" cy="10" r="3" />
					</svg>
					{ui.directionsCta}
				</a>
				</div>
			</div>
			<div class="site-menu__overlay" data-site-menu-overlay hidden>
				<div
					class="site-menu__panel"
					role="dialog"
					aria-modal="true"
					aria-label={ui.menuLabel ?? 'Menu'}
					id="site-menu-panel"
					tabindex="-1"
					data-site-menu-panel
				>
					<div class="site-menu__panel-header">
						<span class="site-menu__panel-title">{ui.menuLabel ?? 'Menu'}</span>
						<button
							class="site-menu__close"
							type="button"
							aria-label="Close"
							data-site-menu-close
						>
							<span aria-hidden="true">×</span>
						</button>
					</div>
					<nav class="site-menu__nav" aria-label={ui.menuLabel ?? 'Menu'}>
						<ul class="site-menu__list">
							{navItems.map((item) => (
								<li>
									<a
										class="site-menu__link"
										href={item.href}
										aria-current={item.href === canonicalPath ? 'page' : undefined}
										data-site-menu-link
									>
										{item.label}
									</a>
								</li>
							))}
						</ul>
					</nav>
				</div>
			</div>
			<LanguageSwitcher
				links={languageLinks}
				ariaLabel={ui.languageLabel ?? 'Language'}
				id="lang-switcher"
			mode="panel"
		/>
			<script type="module" is:inline>
				(() => {
					const toggles = Array.from(document.querySelectorAll('[data-lang-switcher-toggle]'));
					const overlay = document.querySelector('[data-lang-switcher-overlay]');
				const panel = overlay?.querySelector('[data-lang-switcher-panel]');
				const input = overlay?.querySelector('[data-lang-switcher-search]');
				const items = Array.from(overlay?.querySelectorAll('[data-lang-switcher-item]') ?? []);
				const closeButton = overlay?.querySelector('[data-lang-switcher-close]');
				let activeToggle = null;

				document.documentElement.classList.add('lang-switcher--js');

				if (!overlay || !panel || toggles.length === 0) {
					return;
				}

				const isMobile = () => window.matchMedia('(max-width: 859px)').matches;

				const lockBodyScroll = () => {
					const scrollY = window.scrollY || document.documentElement.scrollTop;
					document.body.dataset.scrollY = String(scrollY);
					document.body.style.position = 'fixed';
					document.body.style.top = `-${scrollY}px`;
					document.body.style.left = '0';
					document.body.style.right = '0';
					document.body.style.width = '100%';
				};

				const unlockBodyScroll = () => {
					const scrollY = parseInt(document.body.dataset.scrollY || '0', 10);
					document.body.style.position = '';
					document.body.style.top = '';
					document.body.style.left = '';
					document.body.style.right = '';
					document.body.style.width = '';
					delete document.body.dataset.scrollY;
					window.scrollTo(0, scrollY);
				};

				const applyFilter = () => {
					if (!input) {
						return;
					}
					const query = input.value.trim().toLowerCase();
					items.forEach((item) => {
						const search = (item.dataset.search || '').toLowerCase();
						item.hidden = query.length > 0 && !search.includes(query);
					});
				};

				const setToggleState = (toggle) => {
					toggles.forEach((btn) => {
						btn.setAttribute('aria-expanded', btn === toggle ? 'true' : 'false');
					});
				};

				const setOverlayPosition = (toggle) => {
					if (isMobile()) {
						overlay.style.removeProperty('--lang-switcher-top');
						overlay.style.removeProperty('--lang-switcher-right');
						return;
					}
					const rect = toggle.getBoundingClientRect();
					const top = Math.round(rect.bottom + 8);
					const right = Math.max(12, Math.round(window.innerWidth - rect.right));
					overlay.style.setProperty('--lang-switcher-top', `${top}px`);
					overlay.style.setProperty('--lang-switcher-right', `${right}px`);
				};

				const openPanel = (toggle) => {
					activeToggle = toggle;
					setOverlayPosition(toggle);
					overlay.hidden = false;
					setToggleState(toggle);
					if (isMobile()) {
						lockBodyScroll();
					}
					if (input) {
						input.value = '';
						applyFilter();
						input.focus({ preventScroll: true });
					} else {
						panel.focus({ preventScroll: true });
					}
				};

				const closePanel = () => {
					overlay.hidden = true;
					setToggleState(null);
					if (isMobile()) {
						unlockBodyScroll();
					}
					activeToggle?.focus({ preventScroll: true });
					activeToggle = null;
				};

				toggles.forEach((toggle) => {
					toggle.addEventListener('click', () => {
						if (overlay.hidden) {
							openPanel(toggle);
						} else if (activeToggle === toggle) {
							closePanel();
						} else {
							openPanel(toggle);
						}
					});
				});

				window.addEventListener('resize', () => {
					if (activeToggle) {
						setOverlayPosition(activeToggle);
					}
				});

				document.addEventListener('keydown', (event) => {
					if (event.key === 'Escape' && !overlay.hidden) {
						event.preventDefault();
						closePanel();
					}
				});

				overlay.addEventListener('click', (event) => {
					if (event.target === overlay) {
						closePanel();
					}
				});

				input?.addEventListener('input', applyFilter);
				closeButton?.addEventListener('click', closePanel);
				items.forEach((item) => {
					item.querySelector('a')?.addEventListener('click', closePanel);
				});
				})();
			</script>
			<script type="module" is:inline>
				(() => {
					const toggle = document.querySelector('[data-site-menu-toggle]');
					const overlay = document.querySelector('[data-site-menu-overlay]');
					const panel = overlay?.querySelector('[data-site-menu-panel]');
					const closeButton = overlay?.querySelector('[data-site-menu-close]');
					const links = Array.from(overlay?.querySelectorAll('[data-site-menu-link]') ?? []);

					if (!toggle || !overlay || !panel || !closeButton) {
						return;
					}

					document.documentElement.classList.add('site-menu--js');

					const lockBodyScroll = () => {
						const scrollY = window.scrollY || document.documentElement.scrollTop;
						document.body.dataset.menuScrollY = String(scrollY);
						document.body.style.position = 'fixed';
						document.body.style.top = `-${scrollY}px`;
						document.body.style.left = '0';
						document.body.style.right = '0';
						document.body.style.width = '100%';
					};

					const unlockBodyScroll = () => {
						const scrollY = parseInt(document.body.dataset.menuScrollY || '0', 10);
						document.body.style.position = '';
						document.body.style.top = '';
						document.body.style.left = '';
						document.body.style.right = '';
						document.body.style.width = '';
						delete document.body.dataset.menuScrollY;
						window.scrollTo(0, scrollY);
					};

					const openMenu = () => {
						overlay.hidden = false;
						toggle.setAttribute('aria-expanded', 'true');
						lockBodyScroll();
						panel.focus({ preventScroll: true });
					};

					const closeMenu = () => {
						overlay.hidden = true;
						toggle.setAttribute('aria-expanded', 'false');
						unlockBodyScroll();
						toggle.focus({ preventScroll: true });
					};

					toggle.addEventListener('click', () => {
						if (overlay.hidden) {
							openMenu();
						} else {
							closeMenu();
						}
					});

					closeButton.addEventListener('click', closeMenu);
					links.forEach((link) => link.addEventListener('click', closeMenu));

					document.addEventListener('keydown', (event) => {
						if (event.key === 'Escape' && !overlay.hidden) {
							event.preventDefault();
							closeMenu();
						}
					});
				})();
			</script>
			<script type="module" is:inline>
				(() => {
					const panels = Array.from(document.querySelectorAll('[data-nav-panel]'));
					if (panels.length === 0) {
						return;
					}

					const closeAll = (except = null) => {
						panels.forEach((panel) => {
							if (panel !== except) {
								panel.removeAttribute('open');
							}
						});
					};

					panels.forEach((panel) => {
						panel.addEventListener('toggle', () => {
							if (panel.open) {
								closeAll(panel);
							}
						});
					});

					document.addEventListener('click', (event) => {
						if (!panels.some((panel) => panel.contains(event.target))) {
							closeAll();
						}
					});

					document.addEventListener('keydown', (event) => {
						if (event.key === 'Escape') {
							closeAll();
						}
					});
				})();
			</script>
		</body>
	</html>
