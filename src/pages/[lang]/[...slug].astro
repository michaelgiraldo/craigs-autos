---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { LOCALES, PAGE_PATHS } from '../../lib/site-data.js';

export async function getStaticPaths() {
	const parseEntryPath = (entryId) => entryId.replace(/\.mdx?$/, '').split('/');
	const entries = await getCollection('pages');
	const nonIndexEntries = entries.filter((entry) => {
		const [, ...slugParts] = parseEntryPath(entry.id);
		const slug = slugParts.join('/');
		return slug && slug !== 'index';
	});

	return nonIndexEntries.map((entry) => {
		const [lang, ...slugParts] = parseEntryPath(entry.id);
		const slug = slugParts.join('/');

		return {
			params: {
				lang,
				slug,
			},
			props: { entry },
		};
	});
}

const { entry } = Astro.props;
const [locale, ...slugParts] = entry.id.replace(/\.mdx?$/, '').split('/');
const slug = slugParts.join('/');
const pageKey = entry.data.pageKey;
const translations = PAGE_PATHS[pageKey] ?? PAGE_PATHS.home;
const canonicalPath = translations?.[locale] ?? `/${locale}/${slug}/`;
const lang = LOCALES[locale]?.lang ?? LOCALES.en.lang;
const noindex = entry.data.noindex ?? false;

const { Content } = await render(entry);
---

<BaseLayout
	title={entry.data.title}
	description={entry.data.description}
	locale={locale}
	lang={lang}
	pageKey={pageKey}
	canonicalPath={canonicalPath}
	translations={translations}
	noindex={noindex}
>
	<Content />
</BaseLayout>
