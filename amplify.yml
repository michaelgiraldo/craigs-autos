version: 1
frontend:
  phases:
    preBuild:
      commands:
        - |
          if command -v sudo >/dev/null 2>&1; then
            SUDO=sudo
          else
            SUDO=""
          fi

          if command -v yum >/dev/null 2>&1; then
            $SUDO yum install -y libatomic
          else
            $SUDO apt-get update && $SUDO apt-get install -y libatomic1
          fi
        - npm ci
    build:
      commands:
        - |
          echo "Deploying Amplify Gen 2 backend + generating amplify_outputs.json"
          # Deploy/update the Amplify Gen 2 backend for this branch and write branch-specific
          # `amplify_outputs.json` into `public/` so the site can discover backend endpoints.
          APP_ID="${AWS_APP_ID:-d3du4u03f75wsu}"
          BRANCH="${AWS_BRANCH:-main}"
          NODE_OPTIONS="--localstorage-file=$HOME/.node-localstorage" npx ampx pipeline-deploy \
            --app-id "$APP_ID" \
            --branch "$BRANCH" \
            --outputs-out-dir public \
            --outputs-format json \
            --outputs-version 1.4
        - npm run build
        - npm run indexnow:submit
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
redirects:
  - source: /
    target: https://craigs.autos/en/
    status: 301
  - source: /index.html
    target: https://craigs.autos/en/
    status: 301
  - source: /contact
    target: https://craigs.autos/en/contact/
    status: 301
  - source: /gallery
    target: https://craigs.autos/en/gallery/
    status: 301
  - source: /about-us
    target: https://craigs.autos/en/
    status: 301
  - source: /auto-and-marine-upholstery
    target: https://craigs.autos/en/auto-upholstery/
    status: 301
